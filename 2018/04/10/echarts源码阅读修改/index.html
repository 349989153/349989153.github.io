<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="ie=edge"><title>echarts源码阅读修改 | 陆扬的个人博客</title><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"><script src="/js/third-party/jquery.min.js">           </script><script src="/js/third-party/velocity.min.js">           </script><script src="/js/third-party/velocity.ui.min.js">           </script><link rel="icon" href="/img/favicon.ico"></head><body><nav id="nav-bar"><nav class="clear-fix" id="nav-container"><div class="pull-left" id="page-home"><a href="/">陆扬的个人博客</a></div><i class="fa fa-bars pull-right" id="toggle-nav" aria-hidden="true"></i><ul class="pull-right" id="navs"><li><a class="nav" href="/">Home</a></li><li><a class="nav" href="/about">About</a></li><li><a class="nav" href="/tags">Tags</a></li><li><a class="nav" href="/categories">Categories</a></li></ul></nav></nav><header id="header-info"><div id="header-container"><div id="site-info"><div id="terminal-pl"><div id="top-bar"><ul id="control"><li class="btn"></li><li class="btn"></li><li class="btn"></li></ul><div id="file-path"><i class="fa fa-folder folder-ic" aria-hidden="true"></i> 349989153 10 X 10</div></div><div id="code-pl">Last updated: 2018-04-10<br>349989153:~ Desktop$ <span class="code-pl-input">node echarts源码阅读修改.js</span><br><br>> Post.tags <br><a class="tag" href="#js"><span>js</span></a><a class="tag" href="#echarts"><span>echarts</span></a><br><br>> Post.prev <br><a href="/2018/04/10/Array-prototype-slice及其他Array方法/"><span class="answer">Array.prototype.slice及其他Array方法</span></a><br><br>> Post.next <br><a href="/2018/04/10/阅读redux源码-combineReducer-js/"><span class="answer">阅读redux源码--combineReducer.js</span></a></div></div></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><a class="article-title">echarts源码阅读修改</a><time class="article-date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-10</time><p>产品经理一个蛋疼的需求，着实让我研究了半天。</p>
<a id="more"></a>
<hr>
<p>问题描述：</p>
<p>echarts有个bug，比如如果用下面这套配置（可以到echarts官网=&gt;作品=&gt;官方示例=&gt;随便打开一个，把配置粘进去就能重现。如果你要弄明白我下面在说什么，请重现这张图，下面说的东西都是以这个option生成的图做例子）：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> option = &#123;</span><br><span class="line">    tooltip: &#123;</span><br><span class="line">        trigger: <span class="string">'axis'</span>,</span><br><span class="line">        axisPointer: &#123;</span><br><span class="line">            type: <span class="string">'cross'</span>,</span><br><span class="line">            crossStyle: &#123;</span><br><span class="line">                color: <span class="string">'#999'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    toolbox: &#123;</span><br><span class="line">        feature: &#123;</span><br><span class="line">            dataView: &#123; <span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">readOnly</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">            magicType: &#123; <span class="attr">show</span>: <span class="literal">true</span>, <span class="attr">type</span>: [<span class="string">'line'</span>, <span class="string">'bar'</span>] &#125;,</span><br><span class="line">            restore: &#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">            saveAsImage: &#123; <span class="attr">show</span>: <span class="literal">true</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    legend: &#123;</span><br><span class="line">        data: [<span class="string">'蒸发量'</span>, <span class="string">'平均温度'</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    xAxis: [&#123;</span><br><span class="line">        type: <span class="string">'category'</span>,</span><br><span class="line">        data: [<span class="string">'1月'</span>, <span class="string">'2月'</span>, <span class="string">'3月'</span>, <span class="string">'4月'</span>, <span class="string">'5月'</span>, <span class="string">'6月'</span>, <span class="string">'7月'</span>, <span class="string">'8月'</span>, <span class="string">'9月'</span>, <span class="string">'10月'</span>, <span class="string">'11月'</span>, <span class="string">'12月'</span>],</span><br><span class="line">        axisPointer: &#123;</span><br><span class="line">            type: <span class="string">'shadow'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;],</span><br><span class="line">    yAxis: [&#123;</span><br><span class="line">            type: <span class="string">'value'</span>,</span><br><span class="line">            name: <span class="string">'水量'</span>,</span><br><span class="line">            <span class="comment">// min: 50,</span></span><br><span class="line">            <span class="comment">// max: 250,</span></span><br><span class="line">            <span class="comment">// interval: 50,</span></span><br><span class="line">            axisLabel: &#123;</span><br><span class="line">                formatter: <span class="string">'&#123;value&#125; ml'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            type: <span class="string">'value'</span>,</span><br><span class="line">            name: <span class="string">'温度'</span>,</span><br><span class="line">            <span class="comment">// min: 20,</span></span><br><span class="line">            <span class="comment">// max: 25,</span></span><br><span class="line">            <span class="comment">// interval: 5,</span></span><br><span class="line">            axisLabel: &#123;</span><br><span class="line">                formatter: <span class="string">'&#123;value&#125; °C'</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    series: [&#123;</span><br><span class="line">            name: <span class="string">'蒸发量'</span>,</span><br><span class="line">            type: <span class="string">'bar'</span>,</span><br><span class="line">            data: [<span class="number">2.0</span>, <span class="number">4.9</span>, <span class="number">-7.0</span>, <span class="number">23.2</span>, <span class="number">25.6</span>, <span class="number">76.7</span>, <span class="number">135.6</span>, <span class="number">162.2</span>, <span class="number">32.6</span>, <span class="number">20.0</span>, <span class="number">6.4</span>, <span class="number">3.3</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            name: <span class="string">'平均温度'</span>,</span><br><span class="line">            type: <span class="string">'line'</span>,</span><br><span class="line">            yAxisIndex: <span class="number">1</span>,</span><br><span class="line">            data: [<span class="number">22.0</span>, <span class="number">22.2</span>, <span class="number">23.3</span>, <span class="number">24.5</span>, <span class="number">26.3</span>, <span class="number">20.2</span>, <span class="number">20.3</span>, <span class="number">23.4</span>, <span class="number">23.0</span>, <span class="number">26.5</span>, <span class="number">22.0</span>, <span class="number">26.2</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    dataZoom: [&#123;</span><br><span class="line">        yAxisIndex: <span class="number">1</span>,</span><br><span class="line">        start: <span class="number">0</span>,</span><br><span class="line">        end: <span class="number">100</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure></p>
<p>在放大缩小之前，一切都是正常的，但是一旦你缩放了，x轴的位置就变了，蒸发量有正有负的数据，也不再在x轴的上下显示。</p>
<p>这很奇怪，我明明放大缩小的是y2轴的数据，凭什么y1轴的样子也要跟着变。</p>
<p>目标：</p>
<p>研究echarts代码，看看是否需要重写部分代码，如果需要，怎么重写，能够解决这个问题。</p>
<p>过程：</p>
<p>首先在浏览器中打断点了之后，一路跟踪下来，发现echarts画图是至少分两步的（就目前知道的情况来说），它会先画出坐标轴，再画数据图像，那我们先看坐标轴怎么画的。</p>
<p><code>this._doPaintList(list, paintAll);</code> 这一句是画坐标轴的函数，其中，参数list是一个array，里面的元素是object，应该是坐标轴上点的各种参数。这个list是通过之前一系列复杂的步骤生成的，在下面的文章中，用list指代list，el指代list的元素。</p>
<p>对list进行循环遍历，首先根据el的Zlevel取出指定的Layer（理解为图层）。这里为啥要先取出Layer，是因为echarts支持多层绘制，每一层是一个单独的canvas，所以el要绘制到指定的层的canvas上去。</p>
<p>//TODO:elFrame是干什么的？elFrame == -1是正常的画图，elFrame &gt;= 0是什么?</p>
<p>接着，在循环遍历里，走到最后一步 <code>this._doPaintEl(el, currentLayer, paintAll, scope);</code>  el不用解释了，currentLayer是前面取出来的el指定的图层，//TODO:paintAll和scope不知道是啥</p>
<p>进到 this._doPaintEl(el, currentLayer, paintAll, scope); ，发现最终绘制el的语句是 el.brush(ctx, scope.prevEl || null); ，所以准备进到这个函数里看下，但是看完这个，应该也没必要再深究绘制坐标轴的。</p>
<p>为啥呢？因为很明显，这一部分只是忠实的绘制list里面的el，list是什么样，就会画成什么样，而对于“为什么echarts会这样画这个图？”这个问题，现在可以等价转换为“为什么echarts会生成这个list？”，所以后面我们需要深入研究生成list的算法。但在这之前，先看看el哪些东西影响了画图。</p>
<p>进到 <code>el.brush(ctx, scope.prevEl || null);</code> 里面才发现，即使都是list中的el，它们之间也是互不相同的。如果这个el负责画直线，那么它是Line的实例；如果这个el要显示文字，那么它是Text的实例。el可能是不同的类，它们的相似之处是都有一个叫brush的方法，接收相同的参数，完成差不多的任务。</p>
<p>根据list来画图的部分先看到这里，就像之前说的，看看怎么生成的list。</p>
<p>生成list是靠这一句 <code>var list = this.storage.getDisplayList(true);</code> ，那么这个 <code>getDisplayList(true);</code> 是啥？请看：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getDisplayList: <span class="function"><span class="keyword">function</span> (<span class="params">update, includeIgnore</span>) </span>&#123;</span><br><span class="line">    includeIgnore = includeIgnore || <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (update) &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateDisplayList(includeIgnore);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._displayList;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>复制代码<br>在 <code>getDisplayList(true);</code> 里，<code>this</code>指向的是<code>Storage</code>对象，而<code>Storage._displayList</code>被直接返回了，那么看看里面的 <code>this.updateDisplayList(includeIgnore);</code>是怎么影响<code>Storage._displayList</code>的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">updateDisplayList: <span class="function"><span class="keyword">function</span>(<span class="params">includeIgnore</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._displayListLen = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> roots = <span class="keyword">this</span>._roots;</span><br><span class="line">  <span class="keyword">var</span> displayList = <span class="keyword">this</span>._displayList;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = roots.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">this</span>._updateAndAddDisplayable(roots[i], <span class="literal">null</span>, includeIgnore);</span><br><span class="line">  &#125;</span><br><span class="line">  displayList.length = <span class="keyword">this</span>._displayListLen;</span><br><span class="line">  env.canvasSupported &amp;&amp; timsort(displayList, shapeCompareFunc);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>在上面这段代码中，this指向Storage对象。而<code>this._roots</code>则是一个数组（貌似长度确定是10？），<code>this._roots</code>里面的元素是一个Group对象（也就是代码里的roots[i]）传入到了 <code>this._updateAndAddDisplayable(roots[i], null, includeIgnore);</code> 。</p>
<p>在<code>this._updateAndAddDisplayable(roots[i], null, includeIgnore);</code> 这个函数里不再进行其他调用，说明在这里面对<code>Storage._displayList</code>造成了直接影响，而这个<code>Group</code>作为直接传入 <code>this._updateAndAddDisplayable</code>的参数，肯定有关系。</p>
<p>这个Group是什么呢？</p>
<p>单步调试的时候，研究第一个Group（也就是roots[0]）,发现Group._children是一个数组，有6个元素，5个是Path类，1个是Sub类，其中Sub类是在canvas里绘制基本图形的类，Sub.type如果为’line’,那么就会画一条直线，如果为’rect’,那么会画矩形。</p>
<p>Path类又是什么？点进去详细调查，发现Path.__title的值，和echarts上面toolbox的内容一一对应，于是恍然大悟，原来第一个Group里装着的是toolbox的零件。</p>
<p>接着调查，第二第三个Group的_children都是空数组，看第四个Group。第四个Group的_children只有一个元素，也是一个Group，它的_children,也就是绝对位置roots[3]._children[0]._children里面有9个元素，里面8个是Sub第一条y轴的横线（就是浅灰色，与x轴等长的那几条），剩下一个又是Group，它的_children里面有18个元素，9个Text9个Sub。调查之后发现，9个Text中有8个是第一条y轴的刻度上文字，剩下1个是第一条y轴的名字；9个sub中有8个是第一条y轴的刻度短横线，非常短的一条，位于刻度上文字的右边，剩下1个是第一条y轴本身。所以我们明白了，第四个Group就是第一条y轴的所有零件，包含8条y轴横线，8个刻度上文字，和对应的8条刻度短刻线，1条y轴和1个对应的y轴文字。</p>
<p>那么，第5个Group我们就能猜想一下了，应该是第2条y轴的零件吧。调查了一下，果不其然，确实是第2条y轴的零件。<br>第6个Group的_children也是1个元素的数组，这个元素是Group类；这个Group类的_children还是一个1元素的数组，看它的_children，里面有26个元素，12个Text类，14个Sub类，看了一眼，12个Text是x轴刻线上的文字，也就是1月、2月…12月，而13个Sub类是13条x轴的短刻线，还剩下1个Sub类就是x轴本身了。至此，我们第一阶段的目标应该相当明白了，第4个Group和第5个Group，也就是第2条y轴和x轴的零件生成的方式，是我们达成目的的主体。它俩这个Group是怎么生成的，使我们下一阶段的研究对象。</p>
<p>这一段概括一下剩下的Group都是什么，毕竟不是主体，一笔带过就好。第7个Group没有_children；第8个Group是图例的零件，也就是“蒸发量”和“平均温度”那一块；第9个Group是12个蒸发量的小红块儿；第10个Group是平均温度的那条线，包含了12个圆点和把12个圆点连起来的一条折线。</p>
<p>哦，原来整张图在最开始就已经生成好了，那为什么先出现坐标轴再出现的内容呢？有待探究。</p>
<hr>
<p>好的，那么我们下一阶段的工作就很明确了，假设我们给第2条y轴加上一个新属性叫<code>origin</code>，用来表示这条y轴和x轴的交点：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">yAxis: [&#123;</span><br><span class="line">  type: <span class="string">'value'</span>,</span><br><span class="line">  name: <span class="string">'水量'</span>,</span><br><span class="line">  axisLabel: &#123;</span><br><span class="line">    formatter: <span class="string">'&#123;value&#125; ml'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  type: <span class="string">'value'</span>,</span><br><span class="line">  name: <span class="string">'温度'</span>,</span><br><span class="line">  origin: <span class="number">20</span>,</span><br><span class="line">  axisLabel: &#123;</span><br><span class="line">    formatter: <span class="string">'&#123;value&#125; °C'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<p>ok整理一下，我们有Storage._roots这个Array，里面存放着画一张echarts的所有零件，那么这个Storage._roots是在什么阶段生成的，又是怎么生成的?</p>
<p>那么怎么样修改源码才能让这条y轴的各个零件，还有它的图形（在这个例子中，是第10个Group里的点）都能按照图例来生成</p>
<p>接着上次的文章，我们这次需要知道Storage._roots是在什么时候生成的，以及怎么生成的。</p>
<p>我们watch<code>this._zr.storage._roots</code>的变化（为什么是这个？参考echarts的类依赖图），在<code>setOption</code>里单步调试：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">echartsProto.setOption = <span class="function"><span class="keyword">function</span> (<span class="params">option, notMerge, lazyUpdate</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        zrUtil.assert(!<span class="keyword">this</span>[IN_MAIN_PROCESS], <span class="string">'`setOption` should not be called during main process.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> silent;</span><br><span class="line">    <span class="keyword">if</span> (zrUtil.isObject(notMerge)) &#123;</span><br><span class="line">        lazyUpdate = notMerge.lazyUpdate;</span><br><span class="line">        silent = notMerge.silent;</span><br><span class="line">        notMerge = notMerge.notMerge;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>[IN_MAIN_PROCESS] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._model || notMerge) &#123;</span><br><span class="line">        <span class="keyword">var</span> optionManager = <span class="keyword">new</span> OptionManager(<span class="keyword">this</span>._api);</span><br><span class="line">        <span class="keyword">var</span> theme = <span class="keyword">this</span>._theme;</span><br><span class="line">        <span class="keyword">var</span> ecModel = <span class="keyword">this</span>._model = <span class="keyword">new</span> GlobalModel(<span class="literal">null</span>, <span class="literal">null</span>, theme, optionManager);</span><br><span class="line">        ecModel.init(<span class="literal">null</span>, <span class="literal">null</span>, theme, optionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FIXME</span></span><br><span class="line">    <span class="comment">// ugly</span></span><br><span class="line">    <span class="keyword">this</span>.__lastOnlyGraphic = !!(option &amp;&amp; option.graphic);</span><br><span class="line">    zrUtil.each(option, <span class="function"><span class="keyword">function</span> (<span class="params">o, mainType</span>) </span>&#123;</span><br><span class="line">        mainType !== <span class="string">'graphic'</span> &amp;&amp; (<span class="keyword">this</span>.__lastOnlyGraphic = <span class="literal">false</span>);</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._model.setOption(option, optionPreprocessorFuncs, <span class="keyword">this</span>.__lastOnlyGraphic);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lazyUpdate) &#123;</span><br><span class="line">        <span class="keyword">this</span>[OPTION_UPDATED] = &#123; <span class="attr">silent</span>: silent &#125;;</span><br><span class="line">        <span class="keyword">this</span>[IN_MAIN_PROCESS] = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        updateMethods.prepareAndUpdate.call(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// Ensure zr refresh sychronously, and then pixel in canvas can be</span></span><br><span class="line">        <span class="comment">// fetched after `setOption`.</span></span><br><span class="line">        <span class="keyword">this</span>._zr.flush();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>[OPTION_UPDATED] = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">this</span>[IN_MAIN_PROCESS] = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        flushPendingActions.call(<span class="keyword">this</span>, silent);</span><br><span class="line">        triggerUpdatedEvent.call(<span class="keyword">this</span>, silent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>发现执行完<code>updateMethods.prepareAndUpdate.call(this);</code>这一句之后，<code>this._zr.storage._roots</code>从<code>Array(0)</code>变成了<code>Array(10)</code><br>在<code>updateMethods.prepareAndUpdate.call(this);</code>里：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">prepareAndUpdate: <span class="function"><span class="keyword">function</span>(<span class="params">payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> ecModel = <span class="keyword">this</span>._model;</span><br><span class="line"></span><br><span class="line">  prepareView.call(<span class="keyword">this</span>, <span class="string">'component'</span>, ecModel);</span><br><span class="line"></span><br><span class="line">  prepareView.call(<span class="keyword">this</span>, <span class="string">'chart'</span>, ecModel);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FIXME</span></span><br><span class="line">  <span class="comment">// ugly</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.__lastOnlyGraphic) &#123;</span><br><span class="line">    each(<span class="keyword">this</span>._componentsViews, <span class="function"><span class="keyword">function</span>(<span class="params">componentView</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> componentModel = componentView.__model;</span><br><span class="line">      <span class="keyword">if</span> (componentModel &amp;&amp; componentModel.mainType === <span class="string">'graphic'</span>) &#123;</span><br><span class="line">        componentView.render(componentModel, ecModel, <span class="keyword">this</span>._api, payload);</span><br><span class="line">        updateZ(componentModel, componentView);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.__lastOnlyGraphic = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateMethods.update.call(<span class="keyword">this</span>, payload);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里面，当运行过<code>prepareView.call(this, &#39;component&#39;, ecModel);</code>之后，storage._roots变成了Array(8)，但是这8个Group里面都没有_children；同样的，当运行过<code>prepareView.call(this, &#39;chart&#39;, ecModel);</code>之后，storage._roots变成了Array(10)，新加的两个Group也没有实质的内容。可以认为，这两个语句其实是初始化了storage._roots里面的Group。</p>
<p>而当执行了`updateMethods.update.call(this, payload);storage._roots里面的Group开始有了内容。老规矩，还是进到这个函数里面，它太长了，我截取了一部分显示出来：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO</span></span><br><span class="line"><span class="comment">// Save total ecModel here for undo/redo (after restoring data and before processing data).</span></span><br><span class="line"><span class="comment">// Undo (restoration of total ecModel) can be carried out in 'action' or outside API call.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create new coordinate system each update</span></span><br><span class="line"><span class="comment">// In LineView may save the old coordinate system and use it to get the orignal point</span></span><br><span class="line">coordSysMgr.create(<span class="keyword">this</span>._model, <span class="keyword">this</span>._api);</span><br><span class="line"></span><br><span class="line">processData.call(<span class="keyword">this</span>, ecModel, api);</span><br><span class="line"></span><br><span class="line">stackSeriesData.call(<span class="keyword">this</span>, ecModel);</span><br><span class="line"></span><br><span class="line">coordSysMgr.update(ecModel, api);</span><br><span class="line"></span><br><span class="line">doVisualEncoding.call(<span class="keyword">this</span>, ecModel, payload);</span><br><span class="line"></span><br><span class="line">doRender.call(<span class="keyword">this</span>, ecModel, payload);</span><br></pre></td></tr></table></figure>
<p>发现执行过了<code>doRender.call(this, ecModel, payload);</code>之后storage._roots发生实质性变化，于是打算再深入调查。有点令人不安的是这排成一排的6个方法，前5个是干什么的？</p>
<p>现在能知道，倒数第2个，也就是<code>doVisualEncoding.call(this, ecModel, payload);</code>会给ecModel新加两个属性：<code>ec_colorIdx:2</code>和<code>ec_colorNameMap:{平均温度:&quot;#2f4554&quot;,蒸发量:&quot;#c23531&quot;}</code>。</p>
<p>不过现在管不了这么多了，先试试看只关注<code>doRender.call(this, ecModel, payload);</code>能不能得到想要的结果，在<code>doRender.call(this, ecModel, payload);</code>里面：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doRender</span>(<span class="params">ecModel, payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> api = <span class="keyword">this</span>._api;</span><br><span class="line">  <span class="comment">// Render all components</span></span><br><span class="line">  each(<span class="keyword">this</span>._componentsViews, <span class="function"><span class="keyword">function</span>(<span class="params">componentView</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> componentModel = componentView.__model;</span><br><span class="line">    componentView.render(componentModel, ecModel, api, payload);</span><br><span class="line"></span><br><span class="line">    updateZ(componentModel, componentView);</span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  each(<span class="keyword">this</span>._chartsViews, <span class="function"><span class="keyword">function</span>(<span class="params">chart</span>) </span>&#123;</span><br><span class="line">    chart.__alive = <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Render all charts</span></span><br><span class="line">  ecModel.eachSeries(<span class="function"><span class="keyword">function</span>(<span class="params">seriesModel, idx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chartView = <span class="keyword">this</span>._chartsMap[seriesModel.__viewId];</span><br><span class="line">    chartView.__alive = <span class="literal">true</span>;</span><br><span class="line">    chartView.render(seriesModel, ecModel, api, payload);</span><br><span class="line"></span><br><span class="line">    chartView.group.silent = !!seriesModel.get(<span class="string">'silent'</span>);</span><br><span class="line"></span><br><span class="line">    updateZ(seriesModel, chartView);</span><br><span class="line"></span><br><span class="line">    updateProgressiveAndBlend(seriesModel, chartView);</span><br><span class="line"></span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If use hover layer</span></span><br><span class="line">  updateHoverLayerStatus(<span class="keyword">this</span>._zr, ecModel);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove groups of unrendered charts</span></span><br><span class="line">  each(<span class="keyword">this</span>._chartsViews, <span class="function"><span class="keyword">function</span>(<span class="params">chart</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!chart.__alive) &#123;</span><br><span class="line">      chart.remove(ecModel, api);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">type: <span class="string">'cartesianAxis'</span>,</span><br><span class="line"></span><br><span class="line">  axisPointerClass: <span class="string">'CartesianAxisPointer'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @override</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  render: <span class="function"><span class="keyword">function</span>(<span class="params">axisModel, ecModel, api, payload</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.group.removeAll();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> oldAxisGroup = <span class="keyword">this</span>._axisGroup;</span><br><span class="line">    <span class="keyword">this</span>._axisGroup = <span class="keyword">new</span> graphic.Group();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.group.add(<span class="keyword">this</span>._axisGroup);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!axisModel.get(<span class="string">'show'</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> gridModel = axisModel.getCoordSysModel();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> layout = cartesianAxisHelper.layout(gridModel, axisModel); <span class="comment">//layout接收两个参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> axisBuilder = <span class="keyword">new</span> AxisBuilder(axisModel, layout); <span class="comment">//y轴各个零件在这里面构建的，接受两个参数，this._model和layout</span></span><br><span class="line"></span><br><span class="line">    zrUtil.each(axisBuilderAttrs, axisBuilder.add, axisBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>._axisGroup.add(axisBuilder.getGroup()); <span class="comment">//这里add进去的就是y轴的细节，可见构建y轴是在axisBuilder里完成的。</span></span><br><span class="line"></span><br><span class="line">    zrUtil.each(selfBuilderAttrs, <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (axisModel.get(name + <span class="string">'.show'</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>[<span class="string">'_'</span> + name](axisModel, gridModel, layout.labelInterval);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    graphic.groupTransition(oldAxisGroup, <span class="keyword">this</span>._axisGroup, axisModel);</span><br><span class="line"></span><br><span class="line">    CartesianAxisView.superCall(<span class="keyword">this</span>, <span class="string">'render'</span>, axisModel, ecModel, api, payload);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p><code>componentView.render(componentModel, ecModel, api, payload);</code></p>
<p><code>return helper.intervalScaleGetTicks(this._interval, this._extent, this._niceExtent, this._intervalPrecision);</code><br> 为什么<code>this._interval</code>是5，为什么<code>this._extent</code>是[0, 30],为什么<code>this._niceExtent</code>是[0,25]，为什么用了<code>this._niceExtent</code>?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">axisLine: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> opt = <span class="keyword">this</span>.opt;</span><br><span class="line">  <span class="keyword">var</span> axisModel = <span class="keyword">this</span>.axisModel;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!axisModel.get(<span class="string">'axisLine.show'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> extent = <span class="keyword">this</span>.axisModel.axis.getExtent();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> matrix = <span class="keyword">this</span>._transform;</span><br><span class="line">  <span class="keyword">var</span> pt1 = [extent[<span class="number">0</span>], <span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> pt2 = [extent[<span class="number">1</span>], <span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (matrix) &#123;</span><br><span class="line">    v2ApplyTransform(pt1, pt1, matrix);</span><br><span class="line">    v2ApplyTransform(pt2, pt2, matrix);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.group.add(<span class="keyword">new</span> graphic.Line(graphic.subPixelOptimizeLine(&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Id for animation</span></span><br><span class="line">    anid: <span class="string">'line'</span>,</span><br><span class="line"></span><br><span class="line">    shape: &#123;</span><br><span class="line">      x1: pt1[<span class="number">0</span>],</span><br><span class="line">      y1: pt1[<span class="number">1</span>],</span><br><span class="line">      x2: pt2[<span class="number">0</span>],</span><br><span class="line">      y2: pt2[<span class="number">1</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    style: zrUtil.extend(&#123;</span><br><span class="line">      lineCap: <span class="string">'round'</span></span><br><span class="line">    &#125;, axisModel.getModel(<span class="string">'axisLine.lineStyle'</span>).getLineStyle()),</span><br><span class="line">    strokeContainThreshold: opt.strokeContainThreshold || <span class="number">5</span>,</span><br><span class="line">    silent: <span class="literal">true</span>,</span><br><span class="line">    z2: <span class="number">1</span></span><br><span class="line">  &#125;)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是建造坐标轴线的函数，在我们这个例子中，x轴坐标轴线的位置是需要改变的。在这里面，pt1和pt2经过了变换：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (matrix) &#123;</span><br><span class="line">      v2ApplyTransform(pt1, pt1, matrix);</span><br><span class="line">      v2ApplyTransform(pt2, pt2, matrix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pt1从[0, 0]变成了[100, 643],pt2从[800, 0]变成了[900, 643]，这个matrix变量是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="number">0</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">2</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="number">3</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="number">4</span>: <span class="number">100</span>,</span><br><span class="line">  <span class="number">5</span>: <span class="number">642.8571166992188</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出matrix[4]和matrix[5]应该是和变换有关的。那么matrix1-4都有什么作用呢？也许是矩阵变换吧，目前暂时不知道。<br>Anyway，现在知道了，影响x轴画法的变量，是Echarts._componentsViews[0].__model.axis._extend和axisBuilder._transform, 其中axisBuilder是var axisBuilder = new AxisBuilder(axisModel, layout);弄出来的。</p>
<p>取到var grid = gridModel.coordinateSystem;，然后从grid中取到rect，这是画图区域的矩形，它有x起点有y起点，有width有height。</p>
<p>发现在helper.layout中，var axisPosition = axis.onZero ? ‘onZero’ : rawAxisPosition;是受axis.onZero影响的。尝试一下改axis.onZero会不会好点,也就是Echarts._componentsViews[5].__model.axis.onZero</p>
<p>改写gridProto.update方法就好了！！！！！！<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">each(axesMap.x, <span class="function"><span class="keyword">function</span>(<span class="params">xAxis</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// onZero can not be enabled in these two situations</span></span><br><span class="line">  <span class="comment">// 1. When any other axis is a category axis</span></span><br><span class="line">  <span class="comment">// 2. When any other axis not across 0 point</span></span><br><span class="line">  <span class="keyword">if</span> (ifAxisCanNotOnZero(<span class="string">'y'</span>)) &#123;</span><br><span class="line">    xAxis.onZero = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>那么，怎么去改写呢<br>Echarts._componentsViews[0].__model.axis.scale<br><code>`</code></p>
</article><nav id="pagination"><div class="pagination clear-fix"><div class="page-prev pull-left"><a href="/2018/04/10/Array-prototype-slice及其他Array方法/"><i class="fa fa-chevron-left"> </i><span>Array.prototype.slice及其他Array方法</span></a></div><div class="page-next pull-right"><a href="/2018/04/10/阅读redux源码-combineReducer-js/"><span>阅读redux源码--combineReducer.js</span><i class="fa fa-chevron-right"></i></a></div></div></nav></div></div><footer><div id="footer-inner"><div class="social-icons"></div><p class="design-info">power by <a href="https://hexo.io" target="_blank">Hexo</a> | theme <a href="https://github.com/lazysheep666/terminal_theme" target="_blank">Teminal</a></p><p class="copyright">Copyright © 349989153 Blog 2018</p></div></footer><script src="/js/nav.js"></script><script src="/js/scroll.js"></script><script src="/js/index.js"></script></body></html>